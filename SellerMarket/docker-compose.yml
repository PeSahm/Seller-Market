# Docker Compose for Seller-Market Trading Bot
# Includes OCR service for CAPTCHA solving and trading bot

services:
  # OCR Service for CAPTCHA solving
  ocr:
    image: ghcr.io/pesahm/ocr:latest
    container_name: seller-market-ocr
    ports:
      - "8080:8080"
      - "5001:5001"
    volumes:
      # Cache EasyOCR models to avoid re-downloading
      - ./easyocr_models:/root/.EasyOCR/model
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Trading Bot Service
  trading-bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: seller-market-bot
    depends_on:
      ocr:
        condition: service_healthy
    environment:
      # OCR service URL - uses Docker internal networking
      - OCR_SERVICE_URL=http://ocr:8080
      # Telegram credentials (from .env file)
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_USER_ID=${TELEGRAM_USER_ID}
    volumes:
      # Mount configuration files from host
      - ./config.ini:/app/config.ini:ro
      - ./scheduler_config.json:/app/scheduler_config.json:ro
      - ./locust_config.json:/app/locust_config.json:ro
      # Mount logs and results for persistence
      - ./logs:/app/logs
      - ./order_results:/app/order_results
    restart: unless-stopped

  # Scheduler Service (optional - uncomment to run scheduler)
  # scheduler:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   container_name: seller-market-scheduler
  #   depends_on:
  #     ocr:
  #       condition: service_healthy
  #   environment:
  #     - OCR_SERVICE_URL=http://ocr:8080
  #     - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
  #     - TELEGRAM_USER_ID=${TELEGRAM_USER_ID}
  #   volumes:
  #     - ./config.ini:/app/config.ini:ro
  #     - ./scheduler_config.json:/app/scheduler_config.json:ro
  #     - ./locust_config.json:/app/locust_config.json:ro
  #     - ./logs:/app/logs
  #     - ./order_results:/app/order_results
  #   command: ["python", "scheduler.py"]
  #   restart: unless-stopped

  # Locust Load Testing Service (optional - uncomment for load testing)
  # Note: Locust parameters (users, spawn-rate, run-time, host, processes) are loaded from locust_config.json
  # The --processes flag enables distributed load generation on Linux (uses fork())
  # locust:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   container_name: seller-market-locust
  #   depends_on:
  #     ocr:
  #       condition: service_healthy
  #   environment:
  #     - OCR_SERVICE_URL=http://ocr:8080
  #   ports:
  #     - "8089:8089"
  #   volumes:
  #     - ./config.ini:/app/config.ini:ro
  #     - ./locust_config.json:/app/locust_config.json:ro
  #     - ./scheduler_config.json:/app/scheduler_config.json:ro
  #   command: ["python", "-c", "from scheduler import build_locust_command_from_config; import subprocess; subprocess.run(build_locust_command_from_config('locust -f locustfile_new.py --headless'))"]
  #   restart: unless-stopped

volumes:
  easyocr_models:
    driver: local

networks:
  default:
    name: seller-market-network
